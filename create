<?php
/**
 * create_admin.php
 * Run once to create an admin user securely.
 * IMPORTANT: Delete or rename this file after creating the admin.
 */

session_start();
require_once __DIR__ . "/includes/db.php";

mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);

function h(string $s): string { return htmlspecialchars($s, ENT_QUOTES, 'UTF-8'); }

$created = false;
$error = '';
$info = '';

/* Ensure table exists (safe) */
$conn->query("
CREATE TABLE IF NOT EXISTS admin_users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  is_active TINYINT(1) NOT NULL DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB
");

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim((string)($_POST['username'] ?? ''));
    $password = (string)($_POST['password'] ?? '');
    $confirm  = (string)($_POST['confirm'] ?? '');

    if ($username === '' || $password === '' || $confirm === '') {
        $error = "All fields are required.";
    } elseif (!preg_match('/^[a-zA-Z0-9_.-]{3,50}$/', $username)) {
        $error = "Username must be 3-50 chars and only letters, numbers, underscore, dot, dash.";
    } elseif (strlen($password) < 8) {
        $error = "Password must be at least 8 characters.";
    } elseif ($password !== $confirm) {
        $error = "Passwords do not match.";
    } else {
        // check if username exists
        $stmt = $conn->prepare("SELECT id FROM admin_users WHERE username=? LIMIT 1");
        $stmt->bind_param("s", $username);
        $stmt->execute();
        $res = $stmt->get_result();
        $exists = $res->fetch_assoc();
        $stmt->close();

        if ($exists) {
            $error = "Username already exists.";
        } else {
            $hash = password_hash($password, PASSWORD_DEFAULT);

            $stmt = $conn->prepare("INSERT INTO admin_users (username, password_hash, is_active) VALUES (?, ?, 1)");
            $stmt->bind_param("ss", $username, $hash);
            $stmt->execute();
            $stmt->close();

            $created = true;
            $info = "Admin created successfully. Now DELETE this file (create_admin.php) for security.";
        }
    }
}
?>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Admin</title>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-6">

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <strong>Create Admin User (Run Once)</strong>
        </div>
        <div class="card-body">

          <?php if ($error): ?>
            <div class="alert alert-danger"><?= h($error) ?></div>
          <?php endif; ?>

          <?php if ($created): ?>
            <div class="alert alert-success"><?= h($info) ?></div>
            <a class="btn btn-primary" href="admin/login.php">Go to Admin Login</a>
          <?php else: ?>
            <div class="alert alert-warning">
              After creating the admin, <strong>delete/rename this file</strong> immediately.
            </div>

            <form method="post" autocomplete="off">
              <div class="mb-3">
                <label class="form-label">Username</label>
                <input class="form-control" name="username" required placeholder="admin">
              </div>

              <div class="mb-3">
                <label class="form-label">Password</label>
                <input class="form-control" type="password" name="password" required placeholder="Min 8 characters">
              </div>

              <div class="mb-3">
                <label class="form-label">Confirm Password</label>
                <input class="form-control" type="password" name="confirm" required>
              </div>

              <button class="btn btn-success" type="submit">Create Admin</button>
              <a class="btn btn-outline-secondary" href="admin/login.php">Back to Login</a>
            </form>
          <?php endif; ?>

        </div>
      </div>

    </div>
  </div>
</div>
<script src="assets/js/bootstrap.bundle.min.js"></script>
</body>
</html>